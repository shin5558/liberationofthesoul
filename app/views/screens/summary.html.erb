<%# A画面：キャラ作成完了（光＋キャラ） %>
<% content_for :body_class, "story-view-only" %>

<div class="story-view-wrapper">
  <div class="story-character-summary-wrapper">
    <%= image_tag "character_summary_bg.png",
                  alt: "キャラ作成完了の光の背景",
                  class: "story-character-summary-bg" %>

    <% if @player&.avatar_image&.attached? %>
      <%= image_tag @player.avatar_image,
                    alt: @player.name_kana,
                    class: "story-character-avatar" %>
    <% end %>
  </div>
</div>

<script>
  (function() {
    var currentMode = "<%= session[:screen_mode].presence || 'title' %>";

    function pathForMode(mode) {
      switch (mode) {
        case 'title':     return "<%= screen_title_path %>";
        case 'character': return "<%= screen_character_path %>";
        case 'summary':   return "<%= screen_summary_path %>";
        case 'story':     return "<%= screen_story_path %>";
        case 'battle':    return "<%= screen_battle_path %>";
        default:          return "<%= screen_title_path %>";
      }
    }

    async function checkMode() {
      try {
        const res = await fetch("<%= screen_mode_path %>", { cache: "no-store" });
        if (!res.ok) return;
        const mode = (await res.text()).trim();
        if (!mode || mode === currentMode) return;

        currentMode = mode;
        window.location.href = pathForMode(mode);
      } catch (e) {
        console.warn("screen mode check failed", e);
      }
    }

    setInterval(checkMode, 2000);
  })();
</script>