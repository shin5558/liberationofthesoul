<!-- app/views/stories/general_intro.html.erb -->

<h1>地下通路と将軍</h1>

<section id="general-intro-script">
  <!-- 地下通路への移動〜秘密の通路 -->

  <p class="prologue-line is-narrator"
     data-line-id="narrator_1">
    魔姫の提案を受け入れ、あなたたちは城下町の一角にある古びた建物の裏手へと向かった。<br>
    普段は誰も近寄らないのか、ひっそりとしたその場所には、重そうな鉄扉がひとつだけ、ぽつんと残されている。
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_1">
    「ここよ。<br>
     王族だけが知っている、魔王城へと繋がる秘密の通路。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_1">
    「えっ、そんな大事なこと、私たちに教えちゃっていいの？」
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_2">
    「今は非常時よ。<br>
     あの魔王を止められる可能性があるなら、手段を選んでいる余裕なんてないわ。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_2">
    魔姫が手をかざすと、鉄扉に刻まれた魔法陣が淡く光り、重い音を立てて扉が開いていく。<br>
    その奥には、ひんやりとした空気の漂う石造りの階段が、闇の中へと続いていた。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_2">
    「うわぁ……ほんとに“裏道”って感じだね。<br>
     でも、これなら正面から突っ込むよりは、まだマシかも。」
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_3">
    「ここから先は、あまり大きな声は出さないで。<br>
     通路の一部は、城の兵舎や見張りの近くを通るから。」
  </p>

  <!-- 地下通路の中〜広間に到達 -->

  <p class="prologue-line is-narrator"
     data-line-id="narrator_3">
    石段を降り、長い地下通路を進んでいく。<br>
    足音を殺して進む中、壁に等間隔で設置された魔導灯の灯りだけが、薄暗い道を照らしていた。<br>
    やがて、通路は少しずつ広がり、天井の高い広間のような場所へと続いていく。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_3">
    「ねぇ、魔姫。<br>
     こういう秘密の通路って、罠とかないよね……？」
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_4">
    「……ゼロとは言い切れないけれど、<br>
     少なくとも、ここは昔から王族の避難路として使われていた場所よ。<br>
     罠があっても、私が対処するわ。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_4">
    そう言って魔姫が進む先、地下通路はふっと開け、丸い広間のような空間へと出た。<br>
    壁には古い紋章が刻まれ、中央には、まるで儀式でも行われたかのような円形の模様が描かれている。
  </p>

  <!-- 将軍の登場〜戦闘導入 -->

  <p class="prologue-line is-general"
     data-line-id="general_1">
    「わっはっはっは……待っていたぞ。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_5">
    低く響く笑い声とともに、広間の奥の柱の影から、一人の男が姿を現れる。<br>
    厚い鎧に身を包み、鋭い目つきでこちらを見据えるその姿は、ただの兵士ではないと一目で分かった。
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_5">
    「……あなたは、将軍……！？<br>
     なぜここにいるの。」
  </p>

  <p class="prologue-line is-general"
     data-line-id="general_2">
    「城下に“怪しげな者”が現れたと報告を受けてな。<br>
     部下に調べさせれば、“妖精と共にいる姫様を見た”という者がいると言うではないか。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_6">
    将軍の視線が、魔姫とあなたたちの姿をゆっくりとなぞる。<br>
    その目には、忠義とも執念ともつかない、重い覚悟が宿っていた。
  </p>

  <p class="prologue-line is-general"
     data-line-id="general_3">
    「城にはすでに戻ってきていたようだが――甘かったな、姫様。<br>
     王の許しなく、この通路を使い、外の者と手を組むとは。」
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_6">
    「……分かってるわ。<br>
     でも、あのまま何もしなければ、この国も、世界も滅びるだけよ。」
  </p>

  <p class="prologue-line is-general"
     data-line-id="general_4">
    「たとえそうだとしても、<br>
     余計な真似をする者を放っておくわけにはいかん。<br>
     それが、この身に課せられた“役目”だ。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_4">
    「はぁ……話、ぜんっぜん通じないタイプの人だね。<br>
     こういうの、だいたい戦うしかないんだよね。」
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_7">
    「見つかってしまったからには――もう、後戻りはできないわ。<br>
     お願い、<%= current_player&.name_kana || "あなた" %>。<br>
     あなたの力を、わたしに貸して。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_7">
    将軍は大きな武器を構え、ゆっくりと踏み込んでくる。<br>
    地下広間の空気が、一瞬で張り詰めた。<br>
    ここから――魔王城への道を賭けた、将軍との戦いが始まる。
  </p>
</section>

<hr>

<p>将軍との戦闘に入ります。</p>
<ul>
  <li>
    <%= link_to "将軍との戦闘に入る",
                new_battle_path(player_id: @player.id, enemy_type: "general"),
                class: "btn" %>
  </li>
</ul>

<div style="margin-top: 16px;">
  <%# ★ 自動再生がブロックされたときだけ表示するボタン %>
  <button id="general-intro-play" class="btn" style="display:none;">
    ▶ 音声が再生されないときはこちらをクリック
  </button>
</div>

<audio id="general-intro-audio"></audio>

<script>
  document.addEventListener("DOMContentLoaded", function () {
        // ==== ここだけ追加・重要 ====
    const SCENE_KEY = "general_intro";
    if (!window.voiceCache) window.voiceCache = {};
    if (!window.voiceCache[SCENE_KEY]) window.voiceCache[SCENE_KEY] = {};
    const sceneCache = window.voiceCache[SCENE_KEY];
    // ============================

    // ★ 再生順（SCENES.general_intro.lines と一致）
    const order = [
      "narrator_1",
      "princess_1",
      "fairy_1",
      "princess_2",
      "narrator_2",
      "fairy_2",
      "princess_3",
      "narrator_3",
      "fairy_3",
      "princess_4",
      "narrator_4",
      "general_1",
      "narrator_5",
      "princess_5",
      "general_2",
      "narrator_6",
      "general_3",
      "princess_6",
      "general_4",
      "fairy_4",
      "princess_7",
      "narrator_7"
    ];

    // DOM 要素を保持
    const lineEls = {};
    document
      .querySelectorAll("#general-intro-script .prologue-line")
      .forEach(function (el) {
        const id = el.dataset.lineId;
        if (id) lineEls[id] = el;
      });

    function setActive(lineId) {
      Object.values(lineEls).forEach((el) => {
        el.classList.remove("is-speaking");
      });
      if (lineId && lineEls[lineId]) {
        const el = lineEls[lineId];
        el.classList.add("is-speaking");
        el.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    let currentIndex = -1;
    const audio = new Audio();
    audio.volume = 1.0;

    // ★ グローバルプリロードキャッシュから URL を取る
    function getCachedUrl(sceneKey, lineId) {
      if (!window.voiceCache) return null;
      const sceneCache = window.voiceCache[sceneKey];
      if (!sceneCache) return null;
      return sceneCache[lineId] || null;
    }

    function playNext() {
      currentIndex += 1;

      if (currentIndex >= order.length) {
        setActive(null);
        return;
      }

      const lineId = order[currentIndex];
      setActive(lineId);

      // プリロード済みのものを最優先で使う
      const cached = getCachedUrl("general_intro", lineId);
      if (cached) {
        audio.src = cached;
      } else {
        // プリロードがまだなら、その場で取得
        audio.src =
          "/voices/general_intro?line=" +
          encodeURIComponent(lineId) +
          "&t=" +
          Date.now();
      }

      audio.play().catch((err) => {
        console.warn("general_intro play error:", err);
        const btn = document.getElementById("general-intro-play");
        if (btn) btn.style.display = "inline-block";
      });
    }

    audio.addEventListener("ended", playNext);

    const btn = document.getElementById("general-intro-play");
    if (btn) {
      btn.addEventListener("click", () => {
        btn.style.display = "none";
        currentIndex = -1;
        playNext();
      });
    }

    // ページ表示後に自動再生トライ
    setTimeout(() => {
      currentIndex = -1;
      playNext();
    }, 500);
  });
</script>