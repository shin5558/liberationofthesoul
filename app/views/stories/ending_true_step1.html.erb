<h1>魂の残響エンディング・第一幕</h1>

<section id="ending-true-step1-script">
  <!-- 魔王撃破直後 -->

  <p class="prologue-line is-narrator"
     data-line-id="narrator_1">
    魔王がゆっくりと崩れ落ち、玉座の間に重たい静寂が訪れる。<br>
    さっきまで渦巻いていた闇の魔力は消え、空気の色が、ほんの少しだけ柔らかくなった気がした。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_1">
    「……終わった、のかな。<br>
     やっと……やっと、ここまで来たんだね、<%= current_player&.name_kana || "あなた" %>。」<br>
    「ほら、誰か来る……あの気配……魔姫だ……！」
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_1">
    「間に合ったみたいね……。<br>
     本当に、よくここまで辿り着いてくれたわ、<%= current_player&.name_kana || "あなた" %>。」<br>
    「これで、この世界は――」
  </p>

  <!-- 魔姫の異変 -->

  <p class="prologue-line is-narrator"
     data-line-id="narrator_2">
    感謝の言葉を続けようとした、そのとき。<br>
    魔姫の体から、淡い光の粒が、ぽつり、ぽつりと零れ落ちていた。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_2">
    「……ねぇ、それ……なに、その光……。<br>
     まさか、これって……」
  </p>

  <p class="prologue-line is-princess"
     data-line-id="princess_2">
    「やっぱり……そういうことなのね。<br>
     魔王の血を引く者は、魔王が倒れたあと……<br>
     “夜明けの光”として、この世界に還る……って。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_3">
    光は少しずつ強くなり、彼女の輪郭を、内側から溶かすように揺らめかせていく。<br>
    それは、勝利の代償としては、あまりに残酷な光景だった。
  </p>

  <!-- 魔姫の本心 -->

  <p class="prologue-line is-princess"
     data-line-id="princess_3">
    「ねえ、<%= current_player&.name_kana || "あなた" %>。<br>
     わたしね……あなたと出会って、世界の見え方が変わったの。<br>
     あの日、救われたのは、この国でも、世界でもなく……<br>
     たぶん、わたし自身だった。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_3">
    「やだ……そんなの、聞きたくないよ……。<br>
     だって、それじゃあ、まるで……お別れの挨拶みたいじゃない……。」
  </p>

  <!-- プレイヤーへの最後の願い -->

  <p class="prologue-line is-princess"
     data-line-id="princess_4">
    「最後に――あなたの言葉がほしい。<br>
     わたしが、この世界にいた証を……<br>
     あなたの心のどこかに、残しておいてほしいの。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_4">
    魔姫の瞳は、不思議と穏やかだった。<br>
    まるで、運命の結末を、もう受け入れてしまっているかのように。
  </p>
</section>

<hr>

<p>魔姫に、自分の「最後の言葉」を伝えましょう。</p>
<p>
  <%= link_to "魔姫に言葉を伝える", ending_true_message_story_path, class: "btn" %>
</p>

<div style="margin-top: 16px;">
  <button id="ending-true-step1-play" class="btn" style="display:none;">
    ▶ エンディングボイスが再生されないときはこちらをクリック
  </button>
</div>

<audio id="ending-true-step1-audio"></audio>

<script>
  document.addEventListener("turbo:load", function () {
    // このシーンじゃなければ何もしない
    const container = document.getElementById("ending-true-step1-script");
    if (!container) return;

    // 共通プレイヤーが読み込まれているか確認
    if (!window.setupVoicePlayer) {
      console.error("setupVoicePlayer が見つかりません（ending_true_step1）");
      return;
    }

    // 共通ボイスプレイヤーを起動
    window.setupVoicePlayer({
      // ★ SCENES.ending_true_step1.lines と同じ順番にする
      order: [
        "narrator_1",
        "fairy_1",
        "princess_1",
        "narrator_2",
        "fairy_2",
        "princess_2",
        "narrator_3",
        "princess_3",
        "fairy_3",
        "princess_4",
        "narrator_4"
      ],
      containerSelector: "#ending-true-step1-script",
      lineSelector: ".prologue-line",
      playButtonSelector: "#ending-true-step1-play",
      // ★ 元のコードと同じエンドポイントを使う
      basePath: "/voices/ending_true"
    });
  });
</script>