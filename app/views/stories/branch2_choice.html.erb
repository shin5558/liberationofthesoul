<!-- app/views/stories/branch2_choice.html.erb -->

<h1>魔王国の城下町にて</h1>

<section id="branch2-choice-script">
  <p class="prologue-line is-fairy"
     data-line-id="fairy_1">
    「ついたね、ここが魔王国の城下町だよ。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_2">
    「今ここにいる魔族達は、戦いが得意ではないみたいだね。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_3">
    「戦える魔族達は、城に集められてるみたい。」
  </p>

  <p class="prologue-line is-voice"
     data-line-id="unknown_1">
    「――そこの方、妖精と共にいる方。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_4">
    「だれ！？」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_1">
    フード付きのローブで全身を隠した者が、路地の陰からこちらへ声をかけてきた。<br>
    その姿は、光の届かない闇に溶け込んでいて、顔の表情まではうかがえない。
  </p>

  <p class="prologue-line is-voice"
     data-line-id="unknown_2">
    「魔王を倒したいなら、私たちと協力しませんか？」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_5">
    「協力したいなら、まずは姿を見せてよ。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_6">
    「あなたみたいな、姿を見せない怪しい魔族とは、協力なんて無理だよ。」
  </p>

  <p class="prologue-line is-voice"
     data-line-id="unknown_3">
    「今ここで姿を晒すのは難しいので……こちらに来ていただけますか？」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_2">
    ここで、あなたはどうするかを決めなければならない。<br>
    この怪しい誘いを退け、そのまま魔王城へ向かうか。<br>
    それとも、危険を承知で、この人物の話に乗ってみるか――。
  </p>
</section>

<hr>

<ul>
  <li>
    <%# 選択肢 2-A: 信用しない → 門番ルートへ %>
    <%= button_to "信用できない、無視してこのまま魔王城へ急ぐ",
                  go_gatekeeper_story_path,
                  method: :post,
                  class: "btn" %>
  </li>
  <li>
    <%# 選択肢 2-B: 信じてついていく → 魔姫ルートへ %>
    <%= button_to "信じてついていくことにする",
                  go_princess_story_path,
                  method: :post,
                  class: "btn" %>
  </li>
</ul>

<div style="margin-top: 16px;">
  <%# ★ 自動再生がブロックされたときだけ表示するボタン %>
  <button id="branch2-play" class="btn" style="display:none;">
    ▶ 音声が再生されないときはこちらをクリック
  </button>
</div>

<audio id="branch2-audio"></audio>

<script>
  document.addEventListener("turbo:load", function () {
    // このページじゃなければ何もしない（他ページへの影響防止）
    const container = document.getElementById("branch2-choice-script");
    if (!container) return;

    // 共通セットアップ関数が無ければ諦める
    if (!window.setupVoicePlayer) {
      console.error("setupVoicePlayer が見つかりません（branch2_choice）");
      return;
    }

    // 共通ボイスプレイヤーを起動
    window.setupVoicePlayer({
      // ★ VoicesController::BRANCH2_LINES と同じ順にする
      order: [
        "fairy_1",
        "fairy_2",
        "fairy_3",
        "unknown_1",
        "fairy_4",
        "narrator_1",
        "unknown_2",
        "fairy_5",
        "fairy_6",
        "unknown_3",
        "narrator_2"
      ],
      containerSelector: "#branch2-choice-script",
      lineSelector: ".prologue-line",
      // ★ 再生ボタンの id はビュー側に合わせて「branch2-play」
      playButtonSelector: "#branch2-play",
      // ★ VoicesController#branch2 に合わせる
      basePath: "/voices/branch2"
    });
  });
</script>