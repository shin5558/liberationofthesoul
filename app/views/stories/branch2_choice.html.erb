<!-- app/views/stories/branch2_choice.html.erb -->

<h1>魔王国の城下町にて</h1>

<section id="branch2-choice-script">
  <p class="prologue-line is-fairy"
     data-line-id="fairy_1">
    「ついたね、ここが魔王国の城下町だよ。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_2">
    「今ここにいる魔族（ひと）達は、戦いが得意ではないみたいだね。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_3">
    「戦える魔族（ひと）達は、城に集められてるみたい。」
  </p>

  <p class="prologue-line is-voice"
     data-line-id="unknown_1">
    「――そこの方、妖精と共にいる方。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_4">
    「だれ！？」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_1">
    フード付きのローブで全身を隠した者が、路地の陰からこちらへ声をかけてきた。<br>
    その姿は、光の届かない闇に溶け込んでいて、顔の表情まではうかがえない。
  </p>

  <p class="prologue-line is-voice"
     data-line-id="unknown_2">
    「魔王を倒したいなら、私たちと協力しませんか？」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_5">
    「協力したいなら、まずは姿を見せてよ。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_6">
    「あなたみたいな、姿を見せない怪しい魔族（ひと）とは、協力なんて無理だよ。」
  </p>

  <p class="prologue-line is-voice"
     data-line-id="unknown_3">
    「今ここで姿を晒すのは難しいので……こちらに来ていただけますか？」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_2">
    ここで、あなたはどうするかを決めなければならない。<br>
    この怪しい誘いを退け、そのまま魔王城へ向かうか。<br>
    それとも、危険を承知で、この人物の話に乗ってみるか――。
  </p>
</section>

<hr>

<p>どうする？</p>
<ul>
  <li>
    <%# 選択肢 2-A: 信用しない → 門番ルートへ %>
    <%= button_to "2-A：信用できない、無視してこのまま魔王城へ急ぐ",
                  go_gatekeeper_story_path,
                  method: :post,
                  class: "btn" %>
  </li>
  <li>
    <%# 選択肢 2-B: 信じてついていく → 魔姫ルートへ %>
    <%= button_to "2-B：信じてついていくことにする",
                  go_princess_story_path,
                  method: :post,
                  class: "btn" %>
  </li>
</ul>

<div style="margin-top: 16px;">
  <%# ★ 自動再生がブロックされたときだけ表示するボタン %>
  <button id="branch2-play" class="btn" style="display:none;">
    ▶ 音声が再生されないときはこちらをクリック
  </button>
</div>

<audio id="branch2-audio"></audio>

<script>
  document.addEventListener("DOMContentLoaded", function () {
        // ==== ここだけ追加・重要 ====
    const SCENE_KEY = "branch2_choice";
    if (!window.voiceCache) window.voiceCache = {};
    if (!window.voiceCache[SCENE_KEY]) window.voiceCache[SCENE_KEY] = {};
    const sceneCache = window.voiceCache[SCENE_KEY];
    // ============================


    // ★ 再生順（プリロード設定 SCENES.branch2_choice.lines と一致）
    const order = [
      "fairy_1",
      "fairy_2",
      "fairy_3",
      "unknown_1",
      "fairy_4",
      "narrator_1",
      "unknown_2",
      "fairy_5",
      "fairy_6",
      "unknown_3",
      "narrator_2"
    ];

    // DOM 要素を保持
    const lineEls = {};
    document
      .querySelectorAll("#branch2-choice-script .prologue-line")
      .forEach(function (el) {
        const id = el.dataset.lineId;
        if (id) lineEls[id] = el;
      });

    function setActive(lineId) {
      Object.values(lineEls).forEach((el) => {
        el.classList.remove("is-speaking");
      });
      if (lineId && lineEls[lineId]) {
        const el = lineEls[lineId];
        el.classList.add("is-speaking");
        el.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    let currentIndex = -1;
    const audio = new Audio();
    audio.volume = 1.0;

    // ★ グローバルキャッシュから取り出すヘルパー
    function getCachedUrl(sceneKey, lineId) {
      if (!window.voiceCache) return null;
      const sceneCache = window.voiceCache[sceneKey];
      if (!sceneCache) return null;
      return sceneCache[lineId] || null;
    }

    function playNext() {
      currentIndex += 1;

      if (currentIndex >= order.length) {
        setActive(null);
        return;
      }

      const lineId = order[currentIndex];
      setActive(lineId);

      // プリロード済みなら即使用
      const cached = getCachedUrl("branch2_choice", lineId);
      if (cached) {
        audio.src = cached;
      } else {
        // 万が一プリロードが間に合ってない場合の保険
        audio.src =
          "/voices/branch2?line=" +         // ★ここを branch2 に修正
          encodeURIComponent(lineId) +
          "&t=" +
          Date.now();
      }

      audio.play().catch((err) => {
        console.warn("branch2_choice play error:", err);
        const btn = document.getElementById("branch2-choice-play");
        if (btn) btn.style.display = "inline-block";
      });
    }

    audio.addEventListener("ended", playNext);

    // 手動再生ボタン
    const btn = document.getElementById("branch2-choice-play");
    if (btn) {
      btn.addEventListener("click", () => {
        btn.style.display = "none";
        currentIndex = -1;
        playNext();
      });
    }

    // ページ表示後に自動再生トライ
    setTimeout(() => {
      currentIndex = -1;
      playNext();
    }, 500);
  });
</script>