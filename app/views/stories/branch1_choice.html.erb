<h1>分岐1：森の手前</h1>

<div class="story-text-block">
  <p class="story-line is-narrator js-line" data-line-id="narrator_1">
    森の入口へと続く街道。その先で、何かが横たわっている。近づくにつれ、それが横倒しになった馬車と、その周囲をうろつく小さな影だと分かってくる。
  </p>

  <p class="story-line is-fairy js-line" data-line-id="fairy_1">
    「……先の方に倒れた馬車と、その近くにゴブリンが三匹いるよ。」
  </p>

  <p class="story-line is-narrator js-line" data-line-id="narrator_2">
    耳をすませると、風の流れとは違う、不自然な音が混じっている気がする。
  </p>

  <p class="story-line is-voice js-line" data-line-id="voice_1">
    「……たすけて……！」
  </p>

  <p class="story-line is-fairy js-line" data-line-id="fairy_2">
    「今のは……、悲鳴……？」
  </p>

  <p class="story-line is-narrator js-line" data-line-id="narrator_3">
    道の先では、今にも馬車をあさろうとするゴブリンたち。一方で、森の奥からは、確かに誰かの助けを求める声が聞こえた気がする。
  </p>

  <p class="story-line is-fairy js-line" data-line-id="fairy_3">
    「道の先には、馬車とゴブリン。でも、森の方からも誰かの声が聞こえたよ……。どうする？」
  </p>
</div>

<hr>

<p>分岐1：どうする？</p>
<ul>
  <li>
    <%= button_to "悲鳴は気のせいだろう。目の前のゴブリンを倒す。",
                  go_goblin_story_path,
                  method: :post,
                  class: "btn" %>
  </li>
  <li>
    <%= button_to "悲鳴が気になる、森の中へ確認に行く。",
                  go_thief_story_path,
                  method: :post,
                  class: "btn" %>
  </li>
</ul>

<audio id="scene-audio"></audio>

<script>
  (function() {
    const lines = [
      "narrator_1",
      "fairy_1",
      "narrator_2",
      "voice_1",
      "fairy_2",
      "narrator_3",
      "fairy_3"
    ];

    const audioEl = document.getElementById("scene-audio");

    function highlight(lineId) {
      document.querySelectorAll(".js-line").forEach(el => {
        el.classList.remove("is-speaking");
      });
      const target = document.querySelector(`.js-line[data-line-id="${lineId}"]`);
      if (target) target.classList.add("is-speaking");
    }

    async function playLine(index) {
      if (index >= lines.length) return;
      const id = lines[index];
      highlight(id);

      audioEl.src = `/voices/branch1?line=${encodeURIComponent(id)}`;
      audioEl.play().catch(() => {});
      audioEl.onended = () => playLine(index + 1);
    }

    document.addEventListener("DOMContentLoaded", function() {
      playLine(0);
    });
  })();
</script>