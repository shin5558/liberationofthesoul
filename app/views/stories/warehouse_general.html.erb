<h1>倉庫イベント（将軍ルート）</h1>

<section id="warehouse-general-script">

  <p class="prologue-line is-princess" data-line-id="princess_1">
    「ここに秘密兵器を隠しておいたの。これよ。」
  </p>

  <p class="prologue-line is-narrator" data-line-id="narrator_1">
    薄暗い倉庫の片隅で、古びた木箱の中に淡く光るカードが一枚だけ収められていた。<br>
    属性に縛られない特別な力を宿した――『無属性カード』だった。
  </p>

  <p class="prologue-line is-fairy" data-line-id="fairy_1">
    「これはすごいね……。<br>
     こんなに強い力を、ここまで隠しておくなんてさすが魔姫だよ。」
  </p>

  <p class="prologue-line is-princess" data-line-id="princess_2">
    「これで魔王と戦えるはずよ。<br>
     わたしはみんなが心配だから、向こうと合流するわ。――頑張ってね！」
  </p>

</section>

<hr>

<p>物語を先へ進めましょう。</p>
<ul>
  <li><%= link_to "魔王城へ進む", demonlord_intro_story_path, class: "btn" %></li>
</ul>

<div style="margin-top: 16px;">
  <button id="warehouse-general-play" class="btn" style="display:none;">
    ▶ 音声が再生されないときはこちらをクリック
  </button>
</div>

<audio id="warehouse-general-audio"></audio>

<script>
  document.addEventListener("DOMContentLoaded", function () {
        // ==== ここだけ追加・重要 ====
    const SCENE_KEY = "warehouse_general";
    if (!window.voiceCache) window.voiceCache = {};
    if (!window.voiceCache[SCENE_KEY]) window.voiceCache[SCENE_KEY] = {};
    const sceneCache = window.voiceCache[SCENE_KEY];
    // ============================

    // ★ 再生順（倉庫イベント・将軍ルート）
    const order = ["princess_1", "narrator_1", "fairy_1", "princess_2"];

    // DOM 要素を保持
    const lineEls = {};
    document
      .querySelectorAll("#warehouse-general-script .prologue-line")
      .forEach(function (el) {
        const id = el.dataset.lineId;
        if (id) lineEls[id] = el;
      });

    function setActive(lineId) {
      Object.values(lineEls).forEach(function (el) {
        el.classList.remove("is-speaking", "is-active");
      });
      if (lineId && lineEls[lineId]) {
        const el = lineEls[lineId];
        el.classList.add("is-speaking", "is-active");
        el.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    let currentIndex = -1;
    const audio = document.getElementById("warehouse-general-audio") || new Audio();
    audio.volume = 1.0; // セリフを前に

    // ★ グローバルキャッシュから URL を取るヘルパー
    function getCachedUrl(sceneKey, lineId) {
      if (!window.voiceCache) return null;
      const sceneCache = window.voiceCache[sceneKey];
      if (!sceneCache) return null;
      return sceneCache[lineId] || null;
    }

    function playNext() {
      currentIndex += 1;
      if (currentIndex >= order.length) {
        setActive(null);
        return;
      }

      const lineId = order[currentIndex];
      setActive(lineId);

      // まずはプリロード済みキャッシュを参照
      const cached = getCachedUrl("warehouse_general", lineId);
      if (cached) {
        audio.src = cached;
      } else {
        // 万が一プリロードがまだなら、その場で取得
        audio.src =
          "/voices/warehouse_general?line=" +
          encodeURIComponent(lineId) +
          "&t=" +
          Date.now();
      }

      audio.play().catch(function (err) {
        console.warn("warehouse_general play error:", err);
        const btn = document.getElementById("warehouse-general-play");
        if (btn) btn.style.display = "inline-block";
      });
    }

    audio.addEventListener("ended", playNext);

    const btn = document.getElementById("warehouse-general-play");
    if (btn) {
      btn.addEventListener("click", function () {
        btn.style.display = "none";
        currentIndex = -1;
        playNext();
      });
    }

    // ページ表示後に自動再生を試みる
    setTimeout(function () {
      currentIndex = -1;
      playNext();
    }, 500);
  });
</script>