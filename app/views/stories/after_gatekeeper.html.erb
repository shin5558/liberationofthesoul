<!-- app/views/stories/after_gatekeeper.html.erb -->

<h1>門番撃破後</h1>

<section id="after-gatekeeper-script">
  <p class="prologue-line is-narrator"
     data-line-id="narrator_1">
    戦いが終わった後、重い槍が地面に落ちた音を最後に、周囲は再び静寂を取り戻した。<br>
    門番はゆっくりと膝をつき、そのまま倒れ込むようにして動かなくなる。
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_2">
    あなたは深く息をつきながら、倒れた門番の向こう側に目を向ける。<br>
    そこには――魔王城へ続く巨大な門が、重々しい沈黙の中で佇んでいた。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_1">
    「はぁー……。堅物を倒したよ。これで魔王城に行けるね！」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_3">
    門の前に近づくと、先ほどまで閉ざされていた巨大な扉が、<br>
    あなたたちに反応したかのようにわずかにきしみ、ゆっくりと開きはじめる。
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_4">
    黒い石畳の向こうには、かすかな灯りが揺れる闇の回廊が続いている。<br>
    魔王城の内部が、まるであなたを招くように姿を見せていた。
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_5">
    そのとき、遠くから、不気味な怒号と金属がぶつかり合う音が響いた。<br>
    重い空気を震わせるような戦闘音が、城の奥から伝わってくる。
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_6">
    耳を澄ますと、風に乗って断片的な声が聞こえてくる。<br>
    「くっ……裏切り者どもめ！」「城の制御塔を奪われるな――！」<br>
    どうやら、魔王城の内部で何者かが争っているようだ。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_2">
    「魔族同士が戦っているみたい……。今のうちに魔王城へ行こう！」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_7">
    城門の奥で赤い閃光が一瞬だけ走り、天井の魔導灯がちらつく。<br>
    あなたが一歩踏み出すと、魔王城の深く冷たい空気が、肌にまとわりついてくる。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_3">
    「急ごう。今なら、誰にも気づかれずに進めるかもしれないよ、<br>
     <strong><%= current_player&.name_kana || "あなた" %></strong>！」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_8">
    城の内側で響く激しい戦闘の音を背に、あなたたちはついに――魔王城へ足を踏み入れる。<br>
    物語は、新たな局面へと進み出した。
  </p>
</section>

<hr>

<p>物語を先へ進めましょう。</p>
<ul>
  <li>
    <%# ★ 次のシーンへの遷移先は実際のルーティングに合わせて変更してください %>
    <%# 例: castle_inside_story_path など %>
    <%= link_to "魔王城内部へ進む",
                warehouse_gate_story_path,
                class: "btn" %>
  </li>
</ul>

<div style="margin-top: 16px;">
  <%# ★ 自動再生がブロックされたときだけ表示するボタン %>
  <button id="after-gatekeeper-play" class="btn" style="display:none;">
    ▶ 音声が再生されないときはこちらをクリック
  </button>
</div>

<audio id="after-gatekeeper-audio"></audio>

<script>
  document.addEventListener("DOMContentLoaded", function () {
        // ==== ここだけ追加・重要 ====
    const SCENE_KEY = "prologue";
    if (!window.voiceCache) window.voiceCache = {};
    if (!window.voiceCache[SCENE_KEY]) window.voiceCache[SCENE_KEY] = {};
    const sceneCache = window.voiceCache[SCENE_KEY];
    // ============================

    // ★ 再生順（あなたの SCENES.after_gatekeeper.lines に合わせる）
    const order = [
      "narrator_1",
      "princess_1",
      "fairy_1",
      "princess_2",
      "narrator_2",
      "princess_3",
      "narrator_3",
      "fairy_2",
      "narrator_4",
      "gatekeeper_1",
      "narrator_5",
      "fairy_3",
      "gatekeeper_2",
      "fairy_4",
      "gatekeeper_3",
      "narrator_6",
      "fairy_5",
      "narrator_7"
    ];

    // DOM 要素を保持
    const lineEls = {};
    document
      .querySelectorAll("#after-gatekeeper-script .prologue-line")
      .forEach((el) => {
        const id = el.dataset.lineId;
        if (id) lineEls[id] = el;
      });

    function setActive(lineId) {
      Object.values(lineEls).forEach((el) =>
        el.classList.remove("is-speaking")
      );
      if (lineId && lineEls[lineId]) {
        const el = lineEls[lineId];
        el.classList.add("is-speaking");
        el.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    let currentIndex = -1;
    const audio = new Audio();
    audio.volume = 1.0;

    // ★ プリロードキャッシュ取得
    function getCachedUrl(sceneKey, lineId) {
      if (!window.voiceCache) return null;
      const sceneCache = window.voiceCache[sceneKey];
      if (!sceneCache) return null;
      return sceneCache[lineId] || null;
    }

    function playNext() {
      currentIndex += 1;

      if (currentIndex >= order.length) {
        setActive(null);
        return;
      }

      const lineId = order[currentIndex];
      setActive(lineId);

      const cached = getCachedUrl("after_gatekeeper", lineId);
      if (cached) {
        audio.src = cached;
      } else {
        audio.src =
          "/voices/after_gatekeeper?line=" +
          encodeURIComponent(lineId) +
          "&t=" +
          Date.now();
      }

      audio.play().catch((err) => {
        console.warn("after_gatekeeper play error:", err);
        const btn = document.getElementById("after-gatekeeper-play");
        if (btn) btn.style.display = "inline-block";
      });
    }

    audio.addEventListener("ended", playNext);

    const btn = document.getElementById("after-gatekeeper-play");
    if (btn) {
      btn.addEventListener("click", () => {
        btn.style.display = "none";
        currentIndex = -1;
        playNext();
      });
    }

    // 自動再生
    setTimeout(() => {
      currentIndex = -1;
      playNext();
    }, 500);
  });
</script>