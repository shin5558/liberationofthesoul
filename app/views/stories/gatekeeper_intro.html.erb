<!-- app/views/stories/gatekeeper_intro.html.erb -->

<h1>城門の前で</h1>

<section id="gatekeeper-intro-script">
  <p class="prologue-line is-narrator"
     data-line-id="narrator_1">
    魔王城へと続く大通りを抜けると、視界の先に巨大な城門がそびえ立つ。<br>
    鋭い棘のついた鉄柵が、ここから先は簡単には通さないと主張している。
  </p>

  <p class="prologue-line is-gatekeeper"
     data-line-id="gatekeeper_1">
    「そこの人間、止まれ！」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_1">
    「なに、邪魔するの？」
  </p>

  <p class="prologue-line is-gatekeeper"
     data-line-id="gatekeeper_2">
    「ああ、そういう仕事なんでな。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_2">
    「いいの？ こんなことしてて。<br>
     魔王を止めないと、あなたもどうなるかわからないんだよ？」
  </p>

  <p class="prologue-line is-gatekeeper"
     data-line-id="gatekeeper_3">
    「俺は仕事をするだけだ。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_3">
    「この堅物には、話は通じないみたい…。<br>
     倒そう、<%= current_player&.name_kana || "あなた" %>！」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_2">
    門番は槍を構え、城門の前に立ちはだかる。<br>
    ここを越えなければ、魔王城には辿り着けない――最初の関門の戦いが、今始まろうとしていた。
  </p>
</section>

<hr>
<ul>
  <li>
    <%= link_to "門番との戦闘に入る",
                new_battle_path(player_id: current_player&.id, enemy_type: "gatekeeper"),
                class: "btn" %>
  </li>
</ul>

<div style="margin-top: 16px;">
  <%# ★ 自動再生がブロックされたときだけ表示するボタン %>
  <button id="gatekeeper-play" class="btn" style="display:none;">
    ▶ 音声が再生されないときはこちらをクリック
  </button>
</div>

<audio id="gatekeeper-audio"></audio>

<script>
  document.addEventListener("turbo:load", function () {
    // このページじゃなければ何もしない（他ページへの影響防止）
    const container = document.getElementById("gatekeeper-intro-script");
    if (!container) return;

    // 共通セットアップ関数がなければ諦める
    if (!window.setupVoicePlayer) {
      console.error("setupVoicePlayer が見つかりません（gatekeeper_intro）");
      return;
    }

    // 共通ボイスプレイヤーを起動
    window.setupVoicePlayer({
      // ★ VoicesController::GATEKEEPER_INTRO_LINES と同じ順にする
      order: [
        "narrator_1",
        "gatekeeper_1",
        "fairy_1",
        "gatekeeper_2",
        "fairy_2",
        "gatekeeper_3",
        "fairy_3",
        "narrator_2"
      ],
      containerSelector: "#gatekeeper-intro-script",
      lineSelector: ".prologue-line",
      // 再生ボタンの id に合わせておく
      // （HTML 側が <button id="gatekeeper-play"> ならこれでOK）
      playButtonSelector: "#gatekeeper-play",
      basePath: "/voices/gatekeeper_intro"
    });
  });
</script>