<!-- app/views/stories/after_thief.html.erb -->

<h1>盗賊団を退けて</h1>

<section id="after-thief-script">
  <p class="prologue-line is-narrator"
     data-line-id="narrator_1">
    盗賊たちが地面に倒れ込み、森の中にあった緊張がすっと解けていく。<br>
    さっきまで響いていた怒号も、今はただ、静かな風の音にかき消されていた。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_1">
    「やったー！ 土竜どもを、まとめてやっつけたよ！」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_2">
    リュミエルがくるりと一回転すると、淡い光の粉が周囲にふわりと舞い散る。<br>
    縄で縛られていた女性も、ようやくその場の空気が変わったことに気づいたようだった。
  </p>

  <p class="prologue-line is-voice"
     data-line-id="woman_1">
    「あ、あの……助けてくださって、本当にありがとうございます……！」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_2">
    「――あ、そういえばいたね。すっかり忘れてたよ。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_3">
    あまりに遠慮のないその一言に、女性は思わず肩を落とした。
  </p>

  <p class="prologue-line is-voice"
     data-line-id="woman_2">
    「うぅ……慣れてますから、いいですけど……。<br>
     ……ええと、それよりも、お礼にこちらを受け取ってください。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_4">
    女性が差し出したのは、淡い光を帯びた一枚のカードだった。<br>
    手にした瞬間、指先に小さな鼓動のような力が伝わってくる。
  </p>

  <p class="prologue-line is-voice"
     data-line-id="woman_3">
    「旅の途中で拾った、不思議なカードなんです。<br>
     わたしよりも、あなた達のほうがきっと上手く使えると思って……。」
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_3">
    「わぁ、ありがとう！ 無属性カードだね。<br>
     誰でも使える、便利なやつだよ。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_5">
    カードは、あなたのデッキの中に自然と溶け込むように納まっていく。<br>
    新たな一手を手に入れたという実感が、心を少しだけ軽くした。
  </p>

  <p class="prologue-line is-voice"
     data-line-id="woman_4">
    「わたしは、一度家に戻ります。<br>
     本当にありがとうございました。それでは、失礼します。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_6">
    女性は何度も振り返りながら頭を下げると、森の出口のほうへと小走りに去っていった。
  </p>

  <p class="prologue-line is-fairy"
     data-line-id="fairy_4">
    「バイバーイ！　……ふぅ、なんとか一件落着だね。」
  </p>

  <p class="prologue-line is-narrator"
     data-line-id="narrator_7">
    残されたのは、静けさと、倒れた盗賊たち、そして新しく手に入れたカードだけ。<br>
    森の奥から吹き抜けた風が、あなたたちの背中をそっと押す。<br>
    こうして、土竜盗賊団との一件は幕を閉じ、次の物語へと歩みを進めていく――。
  </p>
</section>

<hr>

<p>物語を進めましょう。</p>
<ul>
  <li>
    <%= link_to "第2の分岐へ進む", branch2_choice_story_path, class: "btn" %>
  </li>
</ul>

<div style="margin-top: 16px;">
  <%# ★ 自動再生がブロックされたときだけ表示するボタン %>
  <button id="after-thief-play" class="btn" style="display:none;">
    ▶ 音声が再生されないときはこちらをクリック
  </button>
</div>

<audio id="after-thief-audio"></audio>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ★ 再生順（上から読んでいく順）
    const order = [
      "narrator_1",
      "fairy_1",
      "narrator_2",
      "woman_1",
      "fairy_2",
      "narrator_3",
      "woman_2",
      "narrator_4",
      "woman_3",
      "fairy_3",
      "narrator_5",
      "woman_4",
      "narrator_6",
      "fairy_4",
      "narrator_7"
    ];

    // DOM 要素を保持
    const lineEls = {};
    document.querySelectorAll("#after-thief-script .prologue-line").forEach(function (el) {
      const id = el.dataset.lineId;
      if (id) lineEls[id] = el;
    });

    function setActive(lineId) {
      Object.values(lineEls).forEach(function (el) {
        el.classList.remove("is-speaking", "is-active");
      });
      if (lineId && lineEls[lineId]) {
        lineEls[lineId].classList.add("is-speaking", "is-active");
        lineEls[lineId].scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    let currentIndex = -1;
    const audio = document.getElementById("after-thief-audio");

    function playNext() {
      currentIndex += 1;
      if (currentIndex >= order.length) {
        setActive(null);
        return;
      }

      const lineId = order[currentIndex];
      setActive(lineId);

      // ★ 盗賊エピローグ用のエンドポイント
      audio.src = "/voices/after_thief?line=" + encodeURIComponent(lineId) + "&t=" + Date.now();
      const playPromise = audio.play();

      if (playPromise && playPromise.catch) {
        playPromise.catch(function (err) {
          console.warn("auto play error:", err);
          const btn = document.getElementById("after-thief-play");
          if (btn) btn.style.display = "inline-block";
        });
      }
    }

    audio.addEventListener("ended", playNext);

    const btn = document.getElementById("after-thief-play");
    if (btn) {
      btn.addEventListener("click", function () {
        btn.style.display = "none";
        currentIndex = -1;
        playNext();
      });
    }

    // ページ表示後に自動再生を試みる
    setTimeout(function () {
      currentIndex = -1;
      playNext();
    }, 500);
  });
</script>