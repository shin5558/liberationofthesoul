<% content_for :body_class, "battle-screen" %>

<% enemy = @battle.enemy %>
<% bg = enemy&.background_asset.presence || "dark_demon_castle_background.png" %>

<% bgm_asset =
     if enemy&.battle_bgm_asset.present?
       enemy.battle_bgm_asset
     else
       "sounds/bgm_default_battle.mp3"
     end %>

<div id="battle-screen"
     data-bg="<%= asset_path(bg) %>"
     data-enemy-code="<%= enemy&.code || 'unknown' %>"
     data-bgm-url="<%= asset_path(bgm_asset) %>">

  <!-- ============================
       Turbo Frameï¼ˆä¸­èº«ã ã‘æ›´æ–°ï¼‰
       ============================ -->
  <turbo-frame id="battle-board">

    <%# ===== çŠ¶æ…‹è¡¨ç¤º ===== %>
    <% if @battle.won? %>
      <h2 style="color: green;">ğŸ‰ å‹åˆ©ï¼æ•µã‚’å€’ã—ã¾ã—ãŸï¼</h2>
    <% elsif @battle.lost? %>
      <h2 style="color: red;">ğŸ’€ æ•—åŒ—â€¦</h2>
    <% else %>
      <h2>ãƒãƒˆãƒ«ç¶™ç¶šä¸­â€¦</h2>
    <% end %>

    <p>
      ã‚ãªãŸ:
      <strong><%= @hand_label %></strong>
      ï¼ æ•µ:
      <strong><%= @cpu_hand_label %></strong>
    </p>
    <p style="font-size:1.1rem;">
      <strong><%= @result_text %></strong>
    </p>

    <%# ===== HP è¨ˆç®— ===== %>
    <% player     = @battle.player %>
    <% player_max = player.base_hp %>
    <% player_now = @battle.player_hp %>
    <% player_pct = ((player_now.to_f / player_max) * 100).round %>

    <% enemy_max = enemy.base_hp %>
    <% enemy_now = @battle.enemy_hp %>
    <% enemy_pct = ((enemy_now.to_f / enemy_max) * 100).round %>

    <div class="battle-wrapper">
      <div class="battle-bg"></div>

      <div class="battle-layer">

        <%# ===== æ•µå´ ===== %>
        <div class="battle-top">
          <div class="card-row">
            <% 5.times do %>
              <div class="card-back"></div>
            <% end %>
          </div>

          <div class="hp-bar" data-target="<%= enemy_pct %>">
            <div class="hp-fill enemy"></div>
          </div>
        </div>

        <%# ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ ===== %>
        <div class="battle-bottom">

          <div class="hp-bar" data-target="<%= player_pct %>">
            <div class="hp-fill player"></div>
          </div>

          <div class="hand-row">
            <% if @player_hands.present? %>
              <% @player_hands.each do |hand| %>
                <% card = hand.card %>
                <% ct   = @battle.card_ct_for(hand.id) %>

                <% status_text =
                     if hand.consumed?
                       "ä½¿ç”¨æ¸ˆã¿"
                     elsif ct > 0
                       "ä½¿ç”¨ã¾ã§æ®‹ã‚Š #{ct} ã‚¿ãƒ¼ãƒ³"
                     else
                       "ä½¿ç”¨å¯èƒ½"
                     end %>

                <% state_class =
                     if hand.consumed?
                       "is-consumed"
                     elsif ct > 0
                       "is-cooldown"
                     else
                       "is-available"
                     end %>

                <% if hand.consumed? || ct > 0 %>
                  <div class="card-button-disabled">
                    <div class="player-card <%= state_class %>">
                      <div class="card-front"></div>
                      <div class="card-tooltip">
                        <div class="card-tooltip-title"><%= card.name %></div>
                        <div class="card-tooltip-desc"><%= card.description %></div>
                        <div class="card-tooltip-status"><%= status_text %></div>
                      </div>
                    </div>
                  </div>
                <% else %>
                  <%= button_to use_battle_card_battle_path(@battle),
                        method: :post,
                        params: { hand_id: hand.id },
                        form:  { data: { turbo_frame: "battle-board" } },
                        class: "card-button" do %>
                    <div class="player-card <%= state_class %>">
                      <div class="card-front"></div>
                      <div class="card-tooltip">
                        <div class="card-tooltip-title"><%= card.name %></div>
                        <div class="card-tooltip-desc"><%= card.description %></div>
                        <div class="card-tooltip-status"><%= status_text %></div>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              <% end %>
            <% else %>
              <% 3.times do %>
                <div class="card-button-disabled">
                  <div class="player-card is-empty">
                    <div class="card-front"></div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <%# ====== ã˜ã‚ƒã‚“ã‘ã‚“ ====== %>
    <div class="battle-controls">
      <p>å‡ºã™æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„:</p>

      <% unless @can_janken %>
        <p style="color:#c00;">â€» å…ˆã«ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ãã ã•ã„</p>
      <% end %>

      <%= button_to "ã‚°ãƒ¼ âœŠ",
            battles_path,
            method: :post,
            params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "g" },
            form: { data: { turbo_frame: "battle-board" } },
            class: "btn jk-btn" %>

      <%= button_to "ãƒãƒ§ã‚­ âœŒï¸",
            battles_path,
            method: :post,
            params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "t" },
            form: { data: { turbo_frame: "battle-board" } },
            class: "btn jk-btn" %>

      <%= button_to "ãƒ‘ãƒ¼ âœ‹",
            battles_path,
            method: :post,
            params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "p" },
            form: { data: { turbo_frame: "battle-board" } },
            class: "btn jk-btn" %>
    </div>

  </turbo-frame>
</div>

<%# ====================================================
    JS ã¯ã€ŒHPãƒãƒ¼ï¼èƒŒæ™¯ã€ã ã‘ã€‚
    BGM ã«ã¯ä¸€åˆ‡è§¦ã‚‰ãªã„ã€‚
    ==================================================== %>
<script>
  (function () {
    function applyHpBars() {
      document.querySelectorAll('.hp-bar').forEach(function(bar){
        const target = parseInt(bar.dataset.target || '0', 10);
        const fill = bar.querySelector('.hp-fill');
        if (!fill) return;

        fill.classList.remove('is-warn','is-danger');
        if (target <= 30) fill.classList.add('is-danger');
        else if (target <= 60) fill.classList.add('is-warn');

        fill.style.width = '0%';
        requestAnimationFrame(() => fill.style.width = target + '%');
      });
    }

    function applyBattleBackground() {
      const c = document.getElementById("battle-screen");
      const bg = c?.dataset?.bg;
      if (c && bg) {
        c.style.backgroundImage = `url(${bg})`;
        c.style.backgroundSize = "cover";
        c.style.backgroundPosition = "center";
      }
    }

    function init() {
      applyHpBars();
      applyBattleBackground();
    }

    document.addEventListener("turbo:load", init);
    document.addEventListener("DOMContentLoaded", init);

    document.addEventListener("turbo:frame-load", function(e) {
      if (e.target.id === "battle-board") {
        init();
      }
    });
  })();
</script>