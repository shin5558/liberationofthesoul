<turbo-frame id="battle-board">

<%# ====== å‹åˆ© / æ•—åŒ— / ç¶™ç¶š ä¸­ ====== %>
<% if @battle.won? %>
  <h2 style="color: green; margin-bottom: 8px;">
    ğŸ‰ å‹åˆ©ï¼æ•µã‚’å€’ã—ã¾ã—ãŸï¼
  </h2>
<% elsif @battle.lost? %>
  <h2 style="color: red; margin-bottom: 8px;">
    ğŸ’€ æ•—åŒ—...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã‚ˆã†ï¼
  </h2>
<% else %>
  <h2 style="margin-bottom: 8px;">
    ãƒãƒˆãƒ«ç¶™ç¶šä¸­â€¦
  </h2>
<% end %>

<p>ã‚ãªãŸã®æ‰‹: <strong><%= @hand_label %></strong></p>
<p>æ•µã®æ‰‹:     <strong><%= @cpu_hand_label %></strong></p>
<p style="font-size:1.2rem; margin: 12px 0;">
  <strong><%= @result_text %></strong>
</p>

<div style="display:flex; gap:20px; justify-content:center; margin-top:20px;">

  <%= button_to "ã‚°ãƒ¼ âœŠ",
        battles_path,
        method: :post,
        params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "g" },
        form: { data: { turbo_frame: "battle-board" } },
        class: "btn" %>

  <%= button_to "ãƒãƒ§ã‚­ âœŒï¸",
        battles_path,
        method: :post,
        params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "t" },
        form: { data: { turbo_frame: "battle-board" } },
        class: "btn" %>

  <%= button_to "ãƒ‘ãƒ¼ âœ‹",
        battles_path,
        method: :post,
        params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "p" },
        form: { data: { turbo_frame: "battle-board" } },
        class: "btn" %>

</div>

<%# === ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ / æ•µ HP ã‚’æ¨ªä¸¦ã³ã§è¡¨ç¤º === %>
<% player     = @battle.player %>
<% player_max = player.base_hp %>
<% player_now = @battle.player_hp %>
<% player_pct = ((player_now.to_f / player_max) * 100).round %>

<% enemy     = @battle.enemy %>
<% enemy_max = enemy.base_hp %>
<% enemy_now = @battle.enemy_hp %>
<% enemy_pct = ((enemy_now.to_f / enemy_max) * 100).round %>

<div class="hp-area">
  <div class="hp-wrap">
    <div class="hp-head">
      <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼š<%= player.name %></span>
      <span><%= player_now %> / <%= player_max %> HP</span>
    </div>
    <div class="hp-bar" data-target="<%= player_pct %>">
      <div class="hp-fill player"></div>
    </div>
  </div>

  <div class="hp-wrap">
    <div class="hp-head">
      <span>æ•µï¼š<%= enemy.name %></span>
      <span><%= enemy_now %> / <%= enemy_max %> HP</span>
    </div>
    <div class="hp-bar" data-target="<%= enemy_pct %>">
      <div class="hp-fill enemy"></div>
    </div>
  </div>
</div>

<hr style="margin: 12px 0;">

<%# ====== ï¼ˆæˆ¦é—˜ãƒ­ã‚°ã¯ç¾åœ¨éè¡¨ç¤ºï¼‰ ====== %>
<%# logs = (@battle.flags || {})['logs'] || [] %>

<%# === ãƒãƒ•çŠ¶æ…‹è¡¨ç¤ºï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ === %>
<% player_buffs = @battle.buffs_for(:player) %>

<div style="display:flex; gap:24px; margin-bottom:16px; font-size:14px;">
  <div>
    <h3 style="margin-bottom:4px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒ•</h3>
    <% if player_buffs.present? %>
      <ul style="padding-left:16px; list-style:disc;">
        <% player_buffs.each do |stat, info| %>
          <% label =
               case stat.to_s
               when 'attack'  then 'æ”»æ’ƒ'
               when 'defense' then 'é˜²å¾¡'
               when 'speed'   then 'é€Ÿåº¦'
               else stat.to_s
               end %>
          <li>
            <%= label %>
            <%= info['value'] >= 0 ? "+#{info['value']}" : info['value'] %>
            ï¼ˆæ®‹ã‚Š <%= info['turns'] %> ã‚¿ãƒ¼ãƒ³ï¼‰
          </li>
        <% end %>
      </ul>
    <% else %>
      <p style="color:#666;">ãƒãƒ•ãªã—</p>
    <% end %>
  </div>
</div>

<%# --- æ‰‹æœ­ä¸€è¦§ --- %>
<h2>æ‰‹æœ­</h2>
<% if @player_hands.present? %>
  <div style="display:flex;
              flex-wrap:nowrap;         /* ä¸€åˆ—ã«ä¸¦ã¹ã‚‹ */
              gap:8px;                  /* å°‘ã—ç‹­ã‚ */
              overflow-x:auto;          /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯ */
              padding-bottom:4px;">

    <% @player_hands.each do |hand| %>
      <% card = hand.card %>
      <div
        style="
          border:1px solid #ccc;
          padding:6px;
          min-width:150px;
          flex:0 0 auto;">

        <strong><%= card.name %></strong>
        <p style="font-size:0.9rem;"><%= card.description %></p>

        <% unless hand.consumed? %>
          <%= button_to "ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ã†",
                use_battle_card_battle_path(@battle),
                method: :post,
                params: { hand_id: hand.id },
                class: "btn" %>
        <% else %>
          <p style="color:gray; font-size:0.8rem;">ä½¿ç”¨æ¸ˆã¿</p>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <p>æ‰‹æœ­ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<% end %>

<hr style="margin: 20px 0;">

<%# ====== ãƒœã‚¿ãƒ³é¡ ====== %>
<% if @battle.ongoing? %>
  <%# é€²è¡Œä¸­ãªã‚‰ç‰¹ã«è¿½åŠ ãƒœã‚¿ãƒ³ãªã—ï¼ˆä¸Šã®ã˜ã‚ƒã‚“ã‘ã‚“ãƒœã‚¿ãƒ³ã§ç¶šè¡Œï¼‰ %>
<% else %>
  <%# HPãŒ0ã«ãªã£ãŸ â†’ å‹åˆ©/æ•—åŒ—ãƒªã‚¶ãƒ«ãƒˆã‹ã‚‰å†æˆ¦ %>
  <%= link_to "ã‚‚ã†ä¸€åº¦æˆ¦ã†",
              new_battle_path(player_id: (@battle&.player_id || session[:player_id])),
              class: "btn" %>
<% end %>

<%= link_to "ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹", root_path, class: "btn" %>

<script>
(function () {
  function applyHpBars() {
    document.querySelectorAll('.hp-bar').forEach(function(bar){
      var target = parseInt(bar.dataset.target || '0', 10);
      var fill = bar.querySelector('.hp-fill');
      if (!fill) return;

      // è‰²ï¼ˆæ®‹é‡ã§å¤‰åŒ–ï¼‰
      fill.classList.remove('is-warn','is-danger');
      if (target <= 30) {
        fill.classList.add('is-danger');
      } else if (target <= 60) {
        fill.classList.add('is-warn');
      }

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      fill.style.width = '0%';
      requestAnimationFrame(function(){
        fill.style.width = target + '%';
      });
    });
  }

  document.addEventListener('turbo:load', applyHpBars);
  document.addEventListener('DOMContentLoaded', applyHpBars);
})();
</script>

</turbo-frame>