<% content_for :body_class, "battle-screen" %>

<turbo-frame id="battle-board">
  <%# ===== çŠ¶æ…‹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç”»é¢ã®ä¸Šã«è¡¨ç¤ºï¼‰ ===== %>
  <% if @battle.won? %>
    <h2 style="color: green; margin-bottom: 4px;">
      ğŸ‰ å‹åˆ©ï¼æ•µã‚’å€’ã—ã¾ã—ãŸï¼
    </h2>
  <% elsif @battle.lost? %>
    <h2 style="color: red; margin-bottom: 4px;">
      ğŸ’€ æ•—åŒ—...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã‚ˆã†ï¼
    </h2>
  <% else %>
    <h2 style="margin-bottom: 4px;">ãƒãƒˆãƒ«ç¶™ç¶šä¸­â€¦</h2>
  <% end %>

  <p>
    ã‚ãªãŸã®æ‰‹: <strong><%= @hand_label %></strong> /
    æ•µã®æ‰‹: <strong><%= @cpu_hand_label %></strong>
  </p>
  <p style="font-size:1.1rem; margin: 6px 0 12px;">
    <strong><%= @result_text %></strong>
  </p>

  <%# ===== HP è¨ˆç®—ï¼ˆä»Šã¾ã§ã®ãƒ­ã‚¸ãƒƒã‚¯ãã®ã¾ã¾ï¼‰ ===== %>
  <% player     = @battle.player %>
  <% player_max = player.base_hp %>
  <% player_now = @battle.player_hp %>
  <% player_pct = ((player_now.to_f / player_max) * 100).round %>

  <% enemy     = @battle.enemy %>
  <% enemy_max = enemy.base_hp %>
  <% enemy_now = @battle.enemy_hp %>
  <% enemy_pct = ((enemy_now.to_f / enemy_max) * 100).round %>

  <%# =========================
      ãƒãƒˆãƒ«ãƒœãƒ¼ãƒ‰æœ¬ä½“
      ========================= %>
  <div class="battle-wrapper">
    <div class="battle-bg"></div>

    <div class="battle-layer">
      <%# --- ä¸Šå´ï¼šæ•µã‚«ãƒ¼ãƒ‰ + æ•µHP --- %>
      <div class="battle-top">
        <div class="card-row">
          <% 5.times do %>
            <div class="card-back"></div>
          <% end %>
        </div>
        <div class="hp-bar" data-target="<%= enemy_pct %>">
          <div class="hp-fill enemy"></div>
        </div>
      </div>

      <%# --- ä¸‹å´ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP + æ‰‹æœ­ --- %>
      <div class="battle-bottom">
        <div class="hp-bar" data-target="<%= player_pct %>">
          <div class="hp-fill player"></div>
        </div>

<div class="hand-row">
  <% if @player_hands.present? %>
    <% @player_hands.each do |hand| %>
      <% card = hand.card %>
      <% ct   = @battle.card_ct_for(hand.id) %>

      <%# çŠ¶æ…‹ãƒ†ã‚­ã‚¹ãƒˆ %>
      <% status_text =
           if hand.consumed?
             "ä½¿ç”¨æ¸ˆã¿"
           elsif ct > 0
             "ä½¿ç”¨ã¾ã§æ®‹ã‚Š #{ct} ã‚¿ãƒ¼ãƒ³"
           else
             "ä½¿ç”¨å¯èƒ½"
           end %>

      <%# çŠ¶æ…‹ã‚¯ãƒ©ã‚¹ï¼ˆæ è‰²ç”¨ï¼‰ %>
      <% state_class =
           if hand.consumed?
             "is-consumed"
           elsif ct > 0
             "is-cooldown"
           else
             "is-available"
           end %>

      <%# ===============================
         ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’ button_to ã«ã™ã‚‹
         =============================== %>
      <% if hand.consumed? || ct > 0 %>
        <%# ä½¿ãˆãªã„ã‚«ãƒ¼ãƒ‰ã¯ãŸã ã® divï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ä½•ã‚‚ã—ãªã„ï¼‰ %>
        <div class="card-button-disabled">
          <div class="player-card <%= state_class %>">
            <div class="card-front"></div>

            <div class="card-tooltip">
              <div class="card-tooltip-title"><%= card.name %></div>
              <div class="card-tooltip-desc"><%= card.description %></div>
              <div class="card-tooltip-status"><%= status_text %></div>
            </div>
          </div>
        </div>
      <% else %>
        <%= button_to use_battle_card_battle_path(@battle),
              method: :post,
              params: { hand_id: hand.id },
              form:  { data: { turbo_frame: "battle-board" } },
              class: "card-button" do %>
          <div class="player-card <%= state_class %>">
            <div class="card-front"></div>

            <div class="card-tooltip">
              <div class="card-tooltip-title"><%= card.name %></div>
              <div class="card-tooltip-desc"><%= card.description %></div>
              <div class="card-tooltip-status"><%= status_text %></div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>

  <% else %>
    <%# æ‰‹æœ­ãŒãªã„ã¨ãã®ãƒ€ãƒŸãƒ¼ %>
    <% 3.times do %>
      <div class="card-button-disabled">
        <div class="player-card is-empty">
          <div class="card-front"></div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
  <%# ==== ã˜ã‚ƒã‚“ã‘ã‚“ãƒœã‚¿ãƒ³ã¯ãƒãƒˆãƒ«ãƒœãƒ¼ãƒ‰ã®ä¸‹ã«ã¾ã¨ã‚ã‚‹ ==== %>
  <div class="battle-controls">
    <p>å‡ºã™æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„:</p>

    <% unless @can_janken %>
      <p style="color:#c00; font-size:0.9rem;">
        â€» å…ˆã«ã‚«ãƒ¼ãƒ‰ã‚’1æšä½¿ã£ã¦ãã ã•ã„
      </p>
    <% end %>

    <%= button_to "ã‚°ãƒ¼ âœŠ",
          battles_path,
          method: :post,
          params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "g" },
          form: { data: { turbo_frame: "battle-board" } },
          class: "btn jk-btn" %>

    <%= button_to "ãƒãƒ§ã‚­ âœŒï¸",
          battles_path,
          method: :post,
          params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "t" },
          form: { data: { turbo_frame: "battle-board" } },
          class: "btn jk-btn" %>

    <%= button_to "ãƒ‘ãƒ¼ âœ‹",
          battles_path,
          method: :post,
          params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "p" },
          form: { data: { turbo_frame: "battle-board" } },
          class: "btn jk-btn" %>
  </div>

  <script>
    (function () {
      function applyHpBars() {
        document.querySelectorAll('.hp-bar').forEach(function(bar){
          var target = parseInt(bar.dataset.target || '0', 10);
          var fill = bar.querySelector('.hp-fill');
          if (!fill) return;

          // è‰²ï¼ˆæ®‹é‡ã§å¤‰åŒ–ï¼‰
          fill.classList.remove('is-warn','is-danger');
          if (target <= 30) {
            fill.classList.add('is-danger');
          } else if (target <= 60) {
            fill.classList.add('is-warn');
          }

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          fill.style.width = '0%';
          requestAnimationFrame(function(){
            fill.style.width = target + '%';
          });
        });
      }

      document.addEventListener('turbo:load', applyHpBars);
      document.addEventListener('DOMContentLoaded', applyHpBars);
    })();
  </script>
</turbo-frame>
</div>