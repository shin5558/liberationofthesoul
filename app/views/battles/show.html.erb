
<turbo-frame id="battle-board">
<h1>バトル</h1>

<%# ====== 勝利 / 敗北 / 継続 中 ====== %>
<% if @battle.won? %>
  <h2 style="color: green; margin-bottom: 8px;">
    🎉 勝利！敵を倒しました！
  </h2>
<% elsif @battle.lost? %>
  <h2 style="color: red; margin-bottom: 8px;">
    💀 敗北...もう一度挑戦しよう！
  </h2>
<% else %>
  <h2 style="margin-bottom: 8px;">
    バトル継続中…
  </h2>
<% end %>

<p>あなたの手: <strong><%= @hand_label %></strong></p>
<p>敵の手:     <strong><%= @cpu_hand_label %></strong></p>
<p style="font-size:1.2rem; margin: 12px 0;">
  <strong><%= @result_text %></strong>
</p>

<hr>

<p>出す手を選んでください:</p>
<div style="display:flex; gap:20px; justify-content:center; margin-top:20px;">

  <%= button_to "グー ✊",
        battles_path,
        method: :post,
        params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "g" },
        form: { data: { turbo_frame: "battle-board" } },
        class: "btn" %>

  <%= button_to "チョキ ✌️",
        battles_path,
        method: :post,
        params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "t" },
        form: { data: { turbo_frame: "battle-board" } },
        class: "btn" %>

  <%= button_to "パー ✋",
        battles_path,
        method: :post,
        params: { player_id: @battle.player_id, battle_id: @battle.id, hand: "p" },
        form: { data: { turbo_frame: "battle-board" } },
        class: "btn" %>

</div>

<hr>


<%# === プレイヤー HP === %>
<% player     = @battle.player %>
<% player_max = player.base_hp %>
<% player_now = @battle.player_hp %>
<% player_pct = ((player_now.to_f / player_max) * 100).round %>

<div class="hp-wrap">
  <div class="hp-head">
    <span>プレイヤー：<%= player.name %></span>
    <span><%= player_now %> / <%= player_max %> HP</span>
  </div>
  <div class="hp-bar" data-target="<%= player_pct %>">
    <div class="hp-fill player"></div>
  </div>
</div>

<%# === 敵 HP === %>
<% enemy     = @battle.enemy %>
<% enemy_max = enemy.base_hp %>
<% enemy_now = @battle.enemy_hp %>
<% enemy_pct = ((enemy_now.to_f / enemy_max) * 100).round %>

<div class="hp-wrap">
  <div class="hp-head">
    <span>敵：<%= enemy.name %></span>
    <span><%= enemy_now %> / <%= enemy_max %> HP</span>
  </div>
  <div class="hp-bar" data-target="<%= enemy_pct %>">
    <div class="hp-fill enemy"></div>
  </div>
</div>

<hr style="margin: 20px 0;">

<%# ====== 戦闘ログ ====== %>
<% logs = (@battle.flags || {})['logs'] || [] %>

<%# === ここから追加：バフ状態表示 === %>
<% player_buffs = @battle.buffs_for(:player) %>
<% enemy_buffs  = @battle.buffs_for(:enemy) %>

<div style="display:flex; gap:24px; margin-bottom:16px; font-size:14px;">
  <div>
    <h3 style="margin-bottom:4px;">プレイヤーのバフ</h3>
    <% if player_buffs.present? %>
      <ul style="padding-left:16px; list-style:disc;">
        <% player_buffs.each do |stat, info| %>
          <% label =
               case stat.to_s
               when 'attack'  then '攻撃'
               when 'defense' then '防御'
               when 'speed'   then '速度'
               else stat.to_s
               end %>
          <li>
            <%= label %>
            <%= info['value'] >= 0 ? "+#{info['value']}" : info['value'] %>
            （残り <%= info['turns'] %> ターン）
          </li>
        <% end %>
      </ul>
    <% else %>
      <p style="color:#666;">バフなし</p>
    <% end %>
  </div>

</div>
<%# === 追加ここまで === %>

<%# --- 手札一覧 --- %>
<h2>手札</h2>
<% if @player_hands.present? %>
  <div style="display:flex;
              flex-wrap:nowrap;         /* ★ 一列に並べる */
              gap:8px;                  /* ★ ちょっとだけ狭く */
              overflow-x:auto;          /* ★ 横スクロール許可 */
              padding-bottom:4px;">

    <% @player_hands.each do |hand| %>
      <% card = hand.card %>
      <div
        style="
          border:1px solid #ccc;
          padding:6px;          /* ★ パディングも少し減らす */
          min-width:150px;      /* ★ 幅も少しだけ細めに */
          flex:0 0 auto;">

          
        <strong><%= card.name %></strong>
        <p style="font-size:0.9rem;"><%= card.description %></p>

        <%# ここでは「このカードを使う」ボタンだけ %>
        <% unless hand.consumed? %>
          <%= button_to "このカードを使う",
                use_battle_card_battle_path(@battle),
                method: :post,
                params: { hand_id: hand.id },
                class: "btn" %>
        <% else %>
          <p style="color:gray; font-size:0.8rem;">使用済み</p>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <p>手札はありません。</p>
<% end %>

<% if logs.present? %>
  <h2 style="margin-top:24px; margin-bottom:8px;">戦闘ログ</h2>

  <ul style="list-style:disc; padding-left:20px; font-size:14px;">
    <% logs.each do |log| %>
      <li style="margin-bottom:4px;">
        ターン <%= log['turn'] %>：
        <% if log['mode'] == 'heal' %>
          回復行動 → プレイヤーHP <%= log['player_hp'] %> / 敵HP <%= log['enemy_hp'] %>
        <% else %>
          あなた：
          <%= BattlesController::HAND_LABELS[log['player_hand']] || '-' %> /
          敵：
          <%= BattlesController::HAND_LABELS[log['cpu_hand']] || '-' %> →
          <% case log['result'] %>
          <% when 'player_win' %>
            あなたの勝ち！
          <% when 'cpu_win' %>
            あなたの負け…
          <% when 'draw' %>
            引き分け（回復）
          <% else %>
            結果不明
          <% end %>
          （HP あなた: <%= log['player_hp'] %> / 敵: <%= log['enemy_hp'] %>）
        <% end %>
      </li>
    <% end %>
  </ul>
<% end %>

<hr style="margin: 20px 0;">

<%# ====== ボタン類 ====== %>
<% if @battle.ongoing? %>

<% else %>
  <%# HPが0になった → 勝利/敗北リザルトから再戦 %>
  <%= link_to "もう一度戦う",
              new_battle_path(player_id: (@battle&.player_id || session[:player_id])),
              class: "btn" %>
<% end %>

<br><br>
<%= link_to "トップに戻る", root_path, class: "btn" %>

<script>
(function () {
  function applyHpBars() {
    document.querySelectorAll('.hp-bar').forEach(function(bar){
      var target = parseInt(bar.dataset.target || '0', 10);
      var fill = bar.querySelector('.hp-fill');
      if (!fill) return;

      // 色（残量で変化）
      fill.classList.remove('is-warn','is-danger');
      if (target <= 30) {
        fill.classList.add('is-danger');
      } else if (target <= 60) {
        fill.classList.add('is-warn');
      }

      // アニメーション
      fill.style.width = '0%';
      requestAnimationFrame(function(){
        fill.style.width = target + '%';
      });
    });
  }

  document.addEventListener('turbo:load', applyHpBars);
  document.addEventListener('DOMContentLoaded', applyHpBars);
})();
</script>

</turbo-frame>