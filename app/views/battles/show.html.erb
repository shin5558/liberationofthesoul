<h1>バトル結果（仮）</h1>

<p>あなたの手: <strong><%= @hand_label %></strong></p>
<p>敵の手:     <strong><%= @cpu_hand_label %></strong></p>
<p style="font-size:1.2rem; margin: 12px 0;"><strong><%= @result_text %></strong></p>

<hr>

<%# === プレイヤー HP === %>
<% player = @battle.player %>
<% player_max = player.base_hp %>
<% player_now = @battle.player_hp %>
<% player_pct = ((player_now.to_f / player_max) * 100).round %>

<div class="hp-wrap">
  <div class="hp-head">
    <span>プレイヤー：<%= player.name %></span>
    <span><%= player_now %> / <%= player_max %> HP</span>
  </div>
  <div class="hp-bar" data-target="<%= player_pct %>">
    <div class="hp-fill player"></div>
  </div>
</div>

<%# === 敵 HP === %>
<% enemy = @battle.enemy %>
<% enemy_max = enemy.base_hp %>
<% enemy_now = @battle.enemy_hp %>
<% enemy_pct = ((enemy_now.to_f / enemy_max) * 100).round %>

<div class="hp-wrap">
  <div class="hp-head">
    <span>敵：<%= enemy.name %></span>
    <span><%= enemy_now %> / <%= enemy_max %> HP</span>
  </div>
  <div class="hp-bar" data-target="<%= enemy_pct %>">
    <div class="hp-fill enemy"></div>
  </div>
</div>
<hr style="margin: 20px 0;">

<% logs = (@battle.flags || {})['logs'] || [] %>

<% if logs.present? %>
  <h2 style="margin-top:24px; margin-bottom:8px;">戦闘ログ</h2>

  <ul style="list-style:disc; padding-left:20px; font-size:14px;">
    <% logs.each do |log| %>
      <li style="margin-bottom:4px;">
        ターン <%= log['turn'] %>：
        <% if log['mode'] == 'heal' %>
          回復行動 → プレイヤーHP <%= log['player_hp'] %> / 敵HP <%= log['enemy_hp'] %>
        <% else %>
          あなた：
          <%= BattlesController::HAND_LABELS[log['player_hand']] || '-' %> /
          敵：
          <%= BattlesController::HAND_LABELS[log['cpu_hand']] || '-' %> →
          <% case log['result'] %>
          <% when 'player_win' %>
            あなたの勝ち！
          <% when 'cpu_win' %>
            あなたの負け…
          <% when 'draw' %>
            引き分け（回復）
          <% else %>
            結果不明
          <% end %>
          （HP あなた: <%= log['player_hp'] %> / 敵: <%= log['enemy_hp'] %>）
        <% end %>
      </li>
    <% end %>
  </ul>
<% end %>

<%= link_to "もう一度戦う",
            new_battle_path(player_id: (@battle&.player_id || session[:player_id])),
            class: "btn" %>
<br><br>
<%= link_to "トップに戻る", root_path, class: "btn" %>

<script>
(function () {
  function applyHpBars() {
    document.querySelectorAll('.hp-bar').forEach(function(bar){
      var target = parseInt(bar.dataset.target || '0', 10);
      var fill = bar.querySelector('.hp-fill');
      if (!fill) return;

      // 色（任意）：残量で色味を変える
      fill.classList.remove('is-warn','is-danger');
      if (target <= 30) {
        fill.classList.add('is-danger');
      } else if (target <= 60) {
        fill.classList.add('is-warn');
      }

      // 初期は0% → 次フレームで目標% にして transition を効かせる
      fill.style.width = '0%';
      requestAnimationFrame(function(){
        fill.style.width = target + '%';
      });
    });
  }

  // Turbo / 通常どちらでも動くよう両方フック
  document.addEventListener('turbo:load', applyHpBars);
  document.addEventListener('DOMContentLoaded', applyHpBars);
})();
</script>