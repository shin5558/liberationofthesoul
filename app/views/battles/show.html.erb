<h1>ãƒãƒˆãƒ«çµæœ</h1>

<%# ====== å‹åˆ© / æ•—åŒ— / ç¶™ç¶š ä¸­ ====== %>
<% if @battle.won? %>
  <h2 style="color: green; margin-bottom: 8px;">
    ğŸ‰ å‹åˆ©ï¼æ•µã‚’å€’ã—ã¾ã—ãŸï¼
  </h2>
<% elsif @battle.lost? %>
  <h2 style="color: red; margin-bottom: 8px;">
    ğŸ’€ æ•—åŒ—...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã‚ˆã†ï¼
  </h2>
<% else %>
  <h2 style="margin-bottom: 8px;">
    ãƒãƒˆãƒ«ç¶™ç¶šä¸­â€¦
  </h2>
<% end %>

<p>ã‚ãªãŸã®æ‰‹: <strong><%= @hand_label %></strong></p>
<p>æ•µã®æ‰‹:     <strong><%= @cpu_hand_label %></strong></p>
<p style="font-size:1.2rem; margin: 12px 0;">
  <strong><%= @result_text %></strong>
</p>

<hr>

<%# === ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ HP === %>
<% player     = @battle.player %>
<% player_max = player.base_hp %>
<% player_now = @battle.player_hp %>
<% player_pct = ((player_now.to_f / player_max) * 100).round %>

<div class="hp-wrap">
  <div class="hp-head">
    <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼š<%= player.name %></span>
    <span><%= player_now %> / <%= player_max %> HP</span>
  </div>
  <div class="hp-bar" data-target="<%= player_pct %>">
    <div class="hp-fill player"></div>
  </div>
</div>

<%# === æ•µ HP === %>
<% enemy     = @battle.enemy %>
<% enemy_max = enemy.base_hp %>
<% enemy_now = @battle.enemy_hp %>
<% enemy_pct = ((enemy_now.to_f / enemy_max) * 100).round %>

<div class="hp-wrap">
  <div class="hp-head">
    <span>æ•µï¼š<%= enemy.name %></span>
    <span><%= enemy_now %> / <%= enemy_max %> HP</span>
  </div>
  <div class="hp-bar" data-target="<%= enemy_pct %>">
    <div class="hp-fill enemy"></div>
  </div>
</div>

<hr style="margin: 20px 0;">

<%# ====== æˆ¦é—˜ãƒ­ã‚° ====== %>
<% logs = (@battle.flags || {})['logs'] || [] %>

<% if logs.present? %>
  <h2 style="margin-top:24px; margin-bottom:8px;">æˆ¦é—˜ãƒ­ã‚°</h2>

  <ul style="list-style:disc; padding-left:20px; font-size:14px;">
    <% logs.each do |log| %>
      <li style="margin-bottom:4px;">
        ã‚¿ãƒ¼ãƒ³ <%= log['turn'] %>ï¼š
        <% if log['mode'] == 'heal' %>
          å›å¾©è¡Œå‹• â†’ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP <%= log['player_hp'] %> / æ•µHP <%= log['enemy_hp'] %>
        <% else %>
          ã‚ãªãŸï¼š
          <%= BattlesController::HAND_LABELS[log['player_hand']] || '-' %> /
          æ•µï¼š
          <%= BattlesController::HAND_LABELS[log['cpu_hand']] || '-' %> â†’
          <% case log['result'] %>
          <% when 'player_win' %>
            ã‚ãªãŸã®å‹ã¡ï¼
          <% when 'cpu_win' %>
            ã‚ãªãŸã®è² ã‘â€¦
          <% when 'draw' %>
            å¼•ãåˆ†ã‘ï¼ˆå›å¾©ï¼‰
          <% else %>
            çµæœä¸æ˜
          <% end %>
          ï¼ˆHP ã‚ãªãŸ: <%= log['player_hp'] %> / æ•µ: <%= log['enemy_hp'] %>ï¼‰
        <% end %>
      </li>
    <% end %>
  </ul>
<% end %>

<hr style="margin: 20px 0;">

<%# ====== ãƒœã‚¿ãƒ³é¡ ====== %>
<% if @battle.ongoing? %>
  <%# ã¾ã HPæ®‹ã£ã¦ã‚‹ â†’ æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸ï¼ˆã˜ã‚ƒã‚“ã‘ã‚“é¸æŠç”»é¢ã¸æˆ»ã‚‹ï¼‰ %>
  <%= link_to "æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸",
              new_battle_path(player_id: (@battle&.player_id || session[:player_id])),
              class: "btn" %>
<% else %>
  <%# HPãŒ0ã«ãªã£ãŸ â†’ å‹åˆ©/æ•—åŒ—ãƒªã‚¶ãƒ«ãƒˆã‹ã‚‰å†æˆ¦ %>
  <%= link_to "ã‚‚ã†ä¸€åº¦æˆ¦ã†",
              new_battle_path(player_id: (@battle&.player_id || session[:player_id])),
              class: "btn" %>
<% end %>

<br><br>
<%= link_to "ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹", root_path, class: "btn" %>

<script>
(function () {
  function applyHpBars() {
    document.querySelectorAll('.hp-bar').forEach(function(bar){
      var target = parseInt(bar.dataset.target || '0', 10);
      var fill = bar.querySelector('.hp-fill');
      if (!fill) return;

      // è‰²ï¼ˆæ®‹é‡ã§å¤‰åŒ–ï¼‰
      fill.classList.remove('is-warn','is-danger');
      if (target <= 30) {
        fill.classList.add('is-danger');
      } else if (target <= 60) {
        fill.classList.add('is-warn');
      }

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      fill.style.width = '0%';
      requestAnimationFrame(function(){
        fill.style.width = target + '%';
      });
    });
  }

  document.addEventListener('turbo:load', applyHpBars);
  document.addEventListener('DOMContentLoaded', applyHpBars);
})();
</script>